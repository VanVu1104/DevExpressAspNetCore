@model IEnumerable<ChiTietDonHangViewModel>

@{
    ViewBag.Title = "Đơn hàng";
    var sizes = ViewBag.Sizes as List<string> ?? new List<string>();
}
<link href="~/css/ctdh.css" rel="stylesheet" />
<script>
    window.contentPath = '/images/';

    function editOrder(id) {
        openModal('/DonHang/Edit/' + id, 'Sửa đơn hàng');
    }

    function deleteOrder(id) {
        Swal.fire({
            title: "Xác nhận xóa?",
            text: "Bạn có chắc muốn xóa đơn hàng này?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Xóa",
            cancelButtonText: "Hủy"
        }).then((result) => {
            if (result.isConfirmed) {
                // TODO: gọi API xóa đơn hàng
                Swal.fire("Đã xóa!", "Đơn hàng đã được xóa.", "success");
            }
        });
    }
    function onCellPrepared(e) {
    if (e.rowType === "data" || e.rowType === "header") {
        e.cellElement.css("text-align", "center");
    }
}
</script>
<script src="~/js/modal.js"></script>
<div id="formModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4 id="modalTitle"></h4>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- nội dung form load bằng AJAX -->
        </div>
    </div>
</div>

<div class="donhang-container">
    <h2>Đơn hàng</h2>
    <button class="btn btn-add" onclick="openModal('/ChiTietDonHang/Create', 'Thêm đơn hàng')">
        Thêm đơn hàng
    </button>
    <br /><br />
    @(
        Html.DevExtreme().DataGrid<ChiTietDonHangViewModel>()
        .ID("donhangGrid")
        .DataSource(ds => ds.Mvc()
        .Controller("ChiTietDonHang")
        .LoadAction("GetAll")
        .Key("IDCTDH")
        )
        .RemoteOperations(true)
        .ShowBorders(true)
        .Paging(p => p.PageSize(10))
        .Pager(pg => pg
        .ShowPageSizeSelector(true)
        .AllowedPageSizes(new int[] { 5, 10, 20, 50 })
        .ShowInfo(true)
        .Visible(true)
        .DisplayMode(GridPagerDisplayMode.Full)
        )
        .ColumnAutoWidth(true)
        .ColumnHidingEnabled(true)
        .Columns(columns =>
        {
            columns.AddFor(m => m.TenChiTietDonHang).Caption("Tên đơn hàng");
            columns.AddFor(m => m.NgayDat).Caption("Ngày đặt").DataType(GridColumnDataType.Date);
            columns.AddFor(m => m.KhachHang).Caption("Khách hàng");
            columns.AddFor(m => m.ProductName).Caption("Product");
            columns.AddFor(m => m.Color).Caption("Color");
            columns.AddFor(m => m.NgayGiaoHang).Caption("Ngày Giao Hàng").DataType(GridColumnDataType.Date);

            columns.AddFor(m => m.ImageUrl).Caption("Ảnh")
            .CellTemplate(@<text>
                               <% if (data.ImageUrl) { %>
                               <img src="<%- data.ImageUrl %>" class="product-img" />
                               <% } else { %>
                               <span class="no-img">No Image</span>
                               <% } %>
                           </text>);

            columns.AddFor(m => m.FilePath).Caption("File")
            .CellTemplate(@<text>
                               <% if (data.FilePath) { %>
                               <a href="<%- data.FilePath %>" target="_blank">Download</a>
                               <% } else { %>
                               <span class="no-img">No File</span>
                               <% } %>
                           </text>);

            columns.Add()
            .Caption("SIZE")
            .Alignment(HorizontalAlignment.Center)
            .Columns(sizeColumns =>
            {
                foreach (var size in sizes)
                {
                    sizeColumns.Add()
                .Caption(size)
                .CellTemplate(@<text>
                                   <%= (data.SizeQuantities && data.SizeQuantities["@(size)"])
                                   ? data.SizeQuantities["@(size)"]
                                   : 0 %>
                               </text>);
                }
            });

            columns.Add().Caption("Thao tác")
            .CellTemplate(@<text>
                               <button class="btn btn-info" onclick="editOrder('<%- data.IDCTDH %>')">
                                   <i class="dx-icon-edit"></i>
                               </button>
                               <button class="btn btn-secondary" onclick="deleteOrder('<%- data.IDCTDH %>')">
                                   <i class="dx-icon-trash"></i>
                               </button>
                           </text>);
        }).OnCellPrepared("onCellPrepared")
        )

</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

